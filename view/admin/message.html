{extend name="admin/layout" /}

{block name="content"}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">留言管理</h5>
        <div>
            <button type="button" class="btn btn-outline-primary" onclick="markAllAsRead()">
                <i class="bi bi-check-all"></i> 全部标记为已读
            </button>
        </div>
    </div>
    <div class="card-body">
        <!-- 筛选器 -->
        <div class="row mb-3">
            <div class="col-md-3">
                <select class="form-select" id="statusFilter">
                    <option value="">全部状态</option>
                    <option value="0">未读</option>
                    <option value="1">已读</option>
                </select>
            </div>
            <div class="col-md-6">
                <div class="input-group">
                    <input type="text" class="form-control" id="searchInput" placeholder="搜索留言...">
                    <button class="btn btn-outline-secondary" type="button" onclick="searchMessages()">
                        <i class="bi bi-search"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 留言列表 -->
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" class="form-check-input" id="selectAll" onchange="toggleSelectAll()">
                        </th>
                        <th>姓名</th>
                        <th>邮箱</th>
                        <th>主题</th>
                        <th>留言内容</th>
                        <th>状态</th>
                        <th>时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="messageTableBody">
                    <tr>
                        <td colspan="8" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">加载中...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- 分页 -->
        <nav aria-label="留言分页">
            <ul class="pagination justify-content-center" id="pagination">
            </ul>
        </nav>
    </div>
</div>

<!-- 留言详情模态框 -->
<div class="modal fade" id="messageModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">留言详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="messageModalBody">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="markAsReadBtn" onclick="markAsRead()">标记为已读</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let messages = [];
let selectedMessages = [];

document.addEventListener('DOMContentLoaded', function() {
    loadMessages();
    
    // 绑定筛选器事件
    document.getElementById('statusFilter').addEventListener('change', loadMessages);
});

function loadMessages() {
    const status = document.getElementById('statusFilter').value;
    const search = document.getElementById('searchInput').value;
    
    let url = `/contact/messages?page=${currentPage}&limit=10`;
    if (status !== '') url += `&status=${status}`;
    if (search) url += `&search=${search}`;
    
    axios.get(url)
        .then(response => {
            if (response.data.code === 200) {
                messages = response.data.data.data;
                displayMessages();
                displayPagination(response.data.data);
            }
        })
        .catch(error => {
            console.error('加载留言失败:', error);
            utils.showError('加载留言失败');
        });
}

function displayMessages() {
    const tbody = document.getElementById('messageTableBody');
    
    if (messages.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">暂无数据</td></tr>';
        return;
    }
    
    let html = '';
    messages.forEach(message => {
        html += `
            <tr>
                <td>
                    <input type="checkbox" class="form-check-input message-checkbox" 
                           value="${message.id}" onchange="toggleMessageSelection(${message.id})">
                </td>
                <td>${message.name}</td>
                <td>${message.email}</td>
                <td>${message.subject || '-'}</td>
                <td>${message.message.substring(0, 50)}${message.message.length > 50 ? '...' : ''}</td>
                <td>
                    <span class="badge bg-${message.status ? 'success' : 'warning'}">
                        ${message.status ? '已读' : '未读'}
                    </span>
                </td>
                <td>${utils.formatDate(message.created_at)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="viewMessage(${message.id})">
                        <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteMessage(${message.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    tbody.innerHTML = html;
}

function displayPagination(paginationData) {
    const pagination = document.getElementById('pagination');
    const totalPages = paginationData.last_page;
    
    let html = '';
    
    // 上一页
    html += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">上一页</a>
        </li>
    `;
    
    // 页码
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
            html += `
                <li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
                </li>
            `;
        } else if (i === currentPage - 3 || i === currentPage + 3) {
            html += '<li class="page-item disabled"><span class="page-link">...</span></li>';
        }
    }
    
    // 下一页
    html += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">下一页</a>
        </li>
    `;
    
    pagination.innerHTML = html;
}

function changePage(page) {
    currentPage = page;
    loadMessages();
}

function searchMessages() {
    currentPage = 1;
    loadMessages();
}

function viewMessage(id) {
    const message = messages.find(m => m.id === id);
    if (!message) return;
    
    const modalBody = document.getElementById('messageModalBody');
    modalBody.innerHTML = `
        <div class="row">
            <div class="col-md-6">
                <strong>姓名：</strong> ${message.name}
            </div>
            <div class="col-md-6">
                <strong>邮箱：</strong> ${message.email}
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <strong>主题：</strong> ${message.subject || '无主题'}
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <strong>留言内容：</strong>
                <div class="mt-2 p-3 bg-light rounded">
                    ${message.message.replace(/\n/g, '<br>')}
                </div>
            </div>
        </div>
        <div class="row mt-3">
            <div class="col-12">
                <strong>时间：</strong> ${utils.formatDate(message.created_at)}
            </div>
        </div>
    `;
    
    // 设置标记为已读按钮
    const markAsReadBtn = document.getElementById('markAsReadBtn');
    if (message.status === 0) {
        markAsReadBtn.style.display = 'inline-block';
        markAsReadBtn.onclick = () => markAsRead(id);
    } else {
        markAsReadBtn.style.display = 'none';
    }
    
    new bootstrap.Modal(document.getElementById('messageModal')).show();
}

function markAsRead(id) {
    axios.post(`/contact/read/${id}`)
        .then(response => {
            if (response.data.code === 200) {
                utils.showSuccess(response.data.message);
                bootstrap.Modal.getInstance(document.getElementById('messageModal')).hide();
                loadMessages();
            }
        })
        .catch(error => {
            console.error('标记已读失败:', error);
            utils.showError('标记已读失败');
        });
}

function deleteMessage(id) {
    utils.confirm('确定要删除这条留言吗？', () => {
        axios.delete(`/contact/message/${id}`)
            .then(response => {
                if (response.data.code === 200) {
                    utils.showSuccess(response.data.message);
                    loadMessages();
                }
            })
            .catch(error => {
                console.error('删除留言失败:', error);
                utils.showError('删除留言失败');
            });
    });
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.message-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
        if (selectAll.checked) {
            selectedMessages.push(parseInt(checkbox.value));
        } else {
            selectedMessages = [];
        }
    });
}

function toggleMessageSelection(id) {
    const index = selectedMessages.indexOf(id);
    if (index > -1) {
        selectedMessages.splice(index, 1);
    } else {
        selectedMessages.push(id);
    }
    
    // 更新全选状态
    const checkboxes = document.querySelectorAll('.message-checkbox');
    const selectAll = document.getElementById('selectAll');
    selectAll.checked = checkboxes.length > 0 && selectedMessages.length === checkboxes.length;
}

function markAllAsRead() {
    if (selectedMessages.length === 0) {
        utils.showWarning('请先选择要标记的留言');
        return;
    }
    
    utils.confirm(`确定要将选中的 ${selectedMessages.length} 条留言标记为已读吗？`, () => {
        const promises = selectedMessages.map(id => 
            axios.post(`/contact/read/${id}`)
        );
        
        Promise.all(promises)
            .then(() => {
                utils.showSuccess('批量标记成功');
                selectedMessages = [];
                document.getElementById('selectAll').checked = false;
                loadMessages();
            })
            .catch(error => {
                console.error('批量标记失败:', error);
                utils.showError('批量标记失败');
            });
    });
}
</script>
{/block} 